name: DICOM Scapy Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Unit tests - no server needed
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scapy pytest

      - name: Run unit tests
        run: |
          pytest test_dicom.py -v -k "not integration"

  # Integration tests against real DICOM servers
  integration-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dicom_server:
          - name: Orthanc
            image: orthancteam/orthanc:latest
            aet: ORTHANC
            port: 4242

          - name: Pynetdicom
            aet: PYNETDICOM
            port: 11112

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scapy pytest pynetdicom
          sudo apt-get update && sudo apt-get install -y tcpdump dcmtk netcat-openbsd tshark

      # Note: scapy_ipv6_fix.py handles IPv6 routing issues in containerized environments
      # It's imported by conftest.py before any scapy imports

      - name: Start tcpdump capture
        id: start_tcpdump
        run: |
          echo "Starting tcpdump capture for port ${{ matrix.dicom_server.port }}..."
          sudo tcpdump port ${{ matrix.dicom_server.port }} -i any -s 0 -w dicom_capture_${{ matrix.dicom_server.name }}.pcap &
          echo "tcpdump_pid=$!" >> $GITHUB_OUTPUT

      - name: Start Orthanc DICOM SCP
        if: matrix.dicom_server.name == 'Orthanc'
        run: |
          echo "Starting Orthanc container..."
          docker run \
            --detach \
            --rm \
            --name dicom-scp-test \
            --publish ${{ matrix.dicom_server.port }}:${{ matrix.dicom_server.port }} \
            -e VERBOSE_ENABLED=true \
            -e DICOM_AET=${{ matrix.dicom_server.aet }} \
            -e DICOM_PORT=${{ matrix.dicom_server.port }} \
            -e ORTHANC__DICOM_AET=${{ matrix.dicom_server.aet }} \
            -e ORTHANC__DICOM_PORT=${{ matrix.dicom_server.port }} \
            ${{ matrix.dicom_server.image }}

          echo "Waiting for Orthanc to become available..."
          timeout 60 bash -c 'until nc -z -w 1 127.0.0.1 ${{ matrix.dicom_server.port }}; do sleep 1; done'
          sleep 5

      - name: Start Pynetdicom DICOM SCP
        if: matrix.dicom_server.name == 'Pynetdicom'
        run: |
          echo "Starting pynetdicom storescp in background..."
          # Use storescp which handles both C-ECHO and C-STORE
          python -m pynetdicom storescp \
            --ae-title ${{ matrix.dicom_server.aet }} \
            --port ${{ matrix.dicom_server.port }} \
            --debug \
            --output /tmp/dicom_received &
          
          echo "Waiting for pynetdicom to start..."
          sleep 3
          timeout 30 bash -c 'until nc -z -w 1 127.0.0.1 ${{ matrix.dicom_server.port }}; do sleep 1; done'
          echo "pynetdicom SCP is ready"

      - name: Verify with echoscu
        run: |
          echo "Running echoscu verification..."
          timeout 15 echoscu -v \
            -aet SCAPY_CI_SCU \
            -aec ${{ matrix.dicom_server.aet }} \
            127.0.0.1 ${{ matrix.dicom_server.port }} \
            || echo "::warning::echoscu command failed or timed out"

      - name: Run Integration Tests
        id: test_script
        continue-on-error: true
        run: |
          TIMEOUT=30
          if [[ "${{ matrix.dicom_server.name }}" == "Orthanc" ]]; then
            TIMEOUT=45
          fi
          echo "Using timeout: $TIMEOUT seconds"

          pytest test_dicom.py \
            --ip 127.0.0.1 \
            --port ${{ matrix.dicom_server.port }} \
            --ae-title ${{ matrix.dicom_server.aet }} \
            --calling-ae SCAPY_CI_SCU \
            --timeout $TIMEOUT \
            -v -s

      - name: Stop tcpdump capture
        if: always()
        run: |
          if [ -n "${{ steps.start_tcpdump.outputs.tcpdump_pid }}" ]; then
            sudo kill ${{ steps.start_tcpdump.outputs.tcpdump_pid }} 2>/dev/null || true
          fi
          sleep 2

      - name: Print PCAP summary
        if: always()
        run: |
          PCAP_FILE="dicom_capture_${{ matrix.dicom_server.name }}.pcap"
          if [[ -f "$PCAP_FILE" ]]; then
            echo "--- PCAP Summary for $PCAP_FILE ---"
            tshark -r "$PCAP_FILE" -c 100 2>/dev/null || true
          fi
        continue-on-error: true

      - name: Upload pcap artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dicom-pcap-${{ matrix.dicom_server.name }}
          path: dicom_capture_${{ matrix.dicom_server.name }}.pcap
          if-no-files-found: ignore

      - name: Show server logs
        if: always()
        run: |
          if [[ "${{ matrix.dicom_server.name }}" == "Orthanc" ]]; then
            docker logs dicom-scp-test 2>&1 | tail -100 || true
          fi

      - name: Stop DICOM SCP
        if: always()
        run: |
          if [[ "${{ matrix.dicom_server.name }}" == "Orthanc" ]]; then
            docker stop dicom-scp-test 2>/dev/null || true
          else
            # Kill pynetdicom processes
            pkill -f "pynetdicom storescp" 2>/dev/null || true
          fi

      - name: Check test outcome
        if: steps.test_script.outcome != 'success'
        run: |
          echo "::error::Integration tests failed for ${{ matrix.dicom_server.name }}"
          exit 1